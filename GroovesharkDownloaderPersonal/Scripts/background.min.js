$(function(){setTimeout(function(){a()},1000);chrome.extension.onConnect.addListener(function(q){console.assert(q.name=="msg");q.onMessage.addListener(function(s){var r={port:q};if(s.method=="download"){r.songId=s.songId;b(r)}})});chrome.browserAction.onClicked.addListener(function(q){window.open("http://www.grooveshark.com","_blank")});function a(){function s(t){return Array.prototype.slice.call(t||[],0)}function q(t){t.forEach(function(u,v){u.remove(function(){},function(){})})}function r(v){var t=v.root.createReader();var u=[];var w=function(){t.readEntries(function(x){if(!x.length){q(u)}else{u=u.concat(s(x));w()}},null)};w()}window.webkitRequestFileSystem(window.TEMPORARY,1024*1024,r)}function b(q){$.ajaxSetup({contentType:"application/json"});h(q,function(r){i(r,function(s){d(s,function(t){e(t,function(u){f(u,function(v){c(v,function(w){n(w)})})})})})})}function h(r,q){var s=new Date();var t=s.getTime()+"\r\n widgets widgetLoaded domain:http://WEgotYOU "+(s.getTime()+100);$.post("http://grooveshark.com/guts.php",t,function(){q(r)})}function i(r,q){r.uuid=Util.GUID();r.country={ID:106,IPR:0,CC4:0,CC1:0,CC3:0,DMA:0,CC2:2199023255552};r.clientRevision="20120113.05";r.client="widget";var t="http://grooveshark.com/more.php?initiateSession";var s={parameters:null,header:{clientRevision:r.clientRevision,client:r.client,country:r.country,uuid:r.uuid},method:"initiateSession"};$.post(t,JSON.stringify(s),function(u){r.sessionId=u.result;q(r)},"json")}function d(r,q){var t="https://grooveshark.com/more.php?getCommunicationToken";var s={header:{session:r.sessionId,client:"htmlshark",clientRevision:"20130520",uuid:r.uuid,privacy:0,country:r.country},method:"getCommunicationToken",parameters:{secretKey:Util.MD5(r.sessionId)}};$.post(t,JSON.stringify(s),function(u){r.cToken=u.result;q(r)},"json")}function e(r,q){var t="http://grooveshark.com/more.php?getQueueSongListFromSongIDs";var s=new Array();s.push(r.songId);g("getQueueSongListFromSongIDs",r.cToken,function(v){var u={parameters:{songIDs:s},header:{token:v,clientRevision:r.clientRevision,client:r.client,country:r.country,uuid:r.uuid,session:r.sessionId},method:"getQueueSongListFromSongIDs"};$.post(t,JSON.stringify(u),function(w){r.songInfo=w.result[0];r.songInfo.Name=r.songInfo.Name.replace("/"," ").replace("\\"," ");q(r)},"json")})}function f(r,q){var s="http://grooveshark.com/more.php?getStreamKeyFromSongIDEx";g("getStreamKeyFromSongIDEx",r.cToken,function(u){var t={parameters:{mobile:false,type:0,prefetch:false,country:r.country,songID:r.songId},header:{token:u,clientRevision:r.clientRevision,client:r.client,country:r.country,uuid:r.uuid,session:r.session},method:"getStreamKeyFromSongIDEx"};$.post(s,JSON.stringify(t),function(v){r.credentials=v.result;q(r)},"json")})}function k(r,q){var s="http://grooveshark.com/more.php?markSongDownloadedEx";g("markSongDownloadedEx",r.cToken,function(u){var t={parameters:{streamServerID:r.credentials.ip,streamKey:r.credentials.streamKey,songID:r.songId},header:{token:u,clientRevision:r.clientRevision,client:r.client,country:r.country,uuid:r.uuid,session:r.sessionId},method:"markSongDownloadedEx"};$.post(s,JSON.stringify(t),function(v){if(q){q(r)}},"json")})}function l(r,q){var s="http://grooveshark.com/more.php?markSongQueueSongPlayed";g("markSongQueueSongPlayed",r.cToken,function(u){var t={parameters:{streamServerID:r.credentials.ip,songQueueID:0,streamKey:r.credentials.streamKey,songQueueSongID:0,songID:r.songId},header:{token:u,clientRevision:r.clientRevision,client:r.client,country:r.country,uuid:r.uuid,session:r.sessionId},method:"markSongQueueSongPlayed"};$.post(s,JSON.stringify(t),function(v){if(q){q(r)}},"json")})}function m(r,q){var s="http://grooveshark.com/more.php?markStreamKeyOver30Seconds";g("markStreamKeyOver30Seconds",r.cToken,function(u){var t={parameters:{streamServerID:r.credentials.ip,songQueueID:0,streamKey:r.credentials.streamKey,songQueueSongID:0,songID:r.songId},header:{token:u,clientRevision:r.clientRevision,client:r.client,country:r.country,uuid:r.uuid,session:r.sessionId},method:"markStreamKeyOver30Seconds"};$.post(s,JSON.stringify(t),function(v){if(q){q(r)}},"json")})}function j(r,q){var s="http://grooveshark.com/more.php?markSongComplete";g("markSongComplete",r.cToken,function(u){var t={parameters:{streamServerID:r.credentials.ip,song:r.songInfo,streamKey:r.credentials.streamKey,context:{type:"unknown",data:{client:r.client}},songID:r.songId},header:{token:u,clientRevision:r.clientRevision,client:r.client,country:r.country,uuid:r.uuid,session:r.sessionId},method:"markSongComplete"};$.post(s,JSON.stringify(t),function(v){if(q){q(r)}},"json")})}function c(r,q){var t="http://"+r.credentials.ip+"/stream.php";var s="streamKey="+r.credentials.streamKey;window.URL=window.URL||window.webkitURL;var u=new XMLHttpRequest();u.open("POST",t,true);u.setRequestHeader("Content-Type","application/x-www-form-urlencoded");u.overrideMimeType("application/octet-stream");u.responseType="arraybuffer";u.onprogress=function(v){o(r,v)};u.onload=function(w){if(this.status==200){var v=this.response;p(r,v,function(){q(r)})}};u.send(s);setTimeout(function(){k(r)},1);setTimeout(function(){l(r)},1);setTimeout(function(){m(r)},30*1000);setTimeout(function(){j(r)},120*1000)}function p(s,q,r){var t=function t(u){var v="";switch(u.code){case FileError.QUOTA_EXCEEDED_ERR:v="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:v="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:v="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:v="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:v="INVALID_STATE_ERR";break;default:v="Unknown Error";break}console.log("Error: "+v)};window.webkitRequestFileSystem(window.TEMPORARY,128*1024*1024,function(u){var v=s.songInfo.ArtistName+" - "+s.songInfo.Name+".mp3";v=v.replace("/","");u.root.getFile(v,{create:true},function(w){w.createWriter(function(A){A.onwriteend=function(B){console.log("Write completed.");s.fileUrl=w.toURL();r(s)};A.onerror=function(B){console.log("Write failed: "+B.toString())};var x;if(window.WebKitBlobBuilder){var y=new window.WebKitBlobBuilder();y.append(q);x=y.getBlob("application/octet-stream")}else{var z=new DataView(q);x=new Blob([z],{type:"application/octet-stream"})}A.write(x)},t)},t)},t)}function g(s,r,q){$.get("http://www.groovesharkdownload.net/home/token?method="+s+"&ct="+r,function(t){if(q){q(t)}})}function o(q,r){var s=(r.loaded/r.total)*100;s=s.toFixed(2);var t=q.port;t.postMessage({method:"updateProgress",songId:q.songId,progress:s})}function n(q){var r=q.port;var s=q.songInfo.ArtistName+" - "+q.songInfo.Name+".mp3";s=s.replace("/","");r.postMessage({method:"downloadComplete",songId:q.songId,url:q.fileUrl,fileName:s})}});